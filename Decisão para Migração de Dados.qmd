---
title: "Seleção de Migração para Datasul"
format: html
editor: visual
---

```{r}
#| warning: false
#| echo: false
#| results: asis

library(tidyverse)
library(stringr)
library(gt)
library(gtExtras)
library(scales)

```

## Projetos Cadastrados no XPert

```{r}
#| warning: false
#| echo: false

alcance <- read_rds("data/escopo-f.rds")

alcance <- 
  alcance |> 
  mutate(prj2 = ifelse(is.na(prj2), "Sem Projeto", prj2)) |> 
  mutate(prj = ifelse(is.na(prj), "Sem Prj", prj))

total <- alcance |> distinct(item) |> nrow()
para_importar <- alcance |>  filter(!is.na(year)) |> distinct(item) |> nrow()
not_importar <- total - para_importar

n_proj <- alcance |> distinct(prj) |> filter(!is.na(prj)) |> nrow()


```

Dados do XPert:

-   `r n_proj` projetos cadastrados.

-   `r total` peças (códigos "F") cadastradas.

Destas peças, `r para_importar` serão importadas para o Datasul, conforme listadas a seguir.

```{r}
#| warning: false
#| echo: false
#| results: asis
# 
# 
# gt_bloco <- function(df){
#   df |>
#     gt()|>
#     tab_options(column_labels.hidden = TRUE) |>
#     as_raw_html()
# }
# 
# df <-
#   alcance |>
#   group_by(prj2) |>
#   summarise(total = n()) |>
#   mutate(bloco = ((row_number() - 1) %/% (n() / 4)))
# 
# df_names <- df |> distinct(bloco) |> pull()
# 
# df |>
#   arrange(prj2) |>
#   group_by(bloco) |>
#   select(everything()) |>
#   group_map(~ gt_bloco(.x)) |>
#   data.frame() |>
#   setNames(df_names) |>
#   gt() |>
#   tab_header(title = "Peças por projeto") |>
#   tab_options(column_labels.hidden = TRUE) |>
#   fmt_markdown(columns = everything())

```

## Peças selecionadas por projeto

As peças importadas são aquelas que apresentam o ano nas tabelas abaixo.

Peças com "NA" não serão importadas.

O "ano" indica uma das duas opções:

-   ano mais recente em que a peça foi vendida (conforme relatórios de vendas fornecidos).

-   ano mais recente em que a peça aparece no relatório de "Pedidos em Carteira".

```{r}
#| echo: false 
#| results: asis 

ff_sub_bloco <- function(df){
  df |>
    gt()|>
    data_color(columns="year",
               fn = col_numeric(palette="Blues",
                                domain = c(2021, 2025))) |>  
    tab_options(column_labels.hidden = TRUE) |>
    as_raw_html()
}

ff_macro_table <- function(df) {
  df <-
    df |>
    mutate(i_block =  (row_number() - 1) %/% (n() / 4))

  f_names <- df |> distinct(i_block) |> pull()
  f_title <- df |> distinct(prj2) |> pull()

  df |>
    group_by(i_block) |>
    select(i_block, year, item) |>
    arrange(-year, item) |> 
    group_map(~ ff_sub_bloco(.x))|>
    data.frame() |>
    setNames(f_names) |>
    gt() |>
    tab_header(title = f_title) |>
    tab_options(column_labels.hidden = TRUE) |>
    fmt_markdown(columns = everything())
}

#df <- alcance |> filter(str_detect(prj, "^XDFA"))
alcance |>
  arrange(prj, -year, rev(item)) |>
  group_by(prj) |>
  select(prj, prj2, year, item) |>
  group_map(~ ff_macro_table(.x))

```
