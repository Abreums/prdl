---
title: "Importações"
author: "Simoldes"
---

```{r}
#| echo: false
#| warning: false

library(tidyverse)
library(janitor)
library(readxl)
library(here)
library(cellranger)
library(gdata)

```

Este arquivo contém referência para o conjunto de importações necessárias para migração de dados do XPERT.

Lista de importações:

-   Itens

    -   Finais

    -   Intermediários

    -   Matéria Prima

-   Estruturas (BOM)

-   Processos (BOP)

-   Fornecedores

# Itens

Carga de dados exportadas do XPert.

```{r}
#| warning: false

source("R/read-itens.R")
itens <- read_itens()
s_itens <- read_itens_summary()

itens |> write_rds("data/itens.rds")
itens <- read_rds("data/itens.rds")

itens |> View()

ja_cadastrados <- 
  readxl::read_excel(here::here("data", "2025-11-10 ja-cadastrados.xlsx"),
                     col_types = "text") |> 
  janitor::clean_names()


s_itens <- 
  ja_cadastrados |> 
  left_join(s_itens, join_by(item))

itens |> 
  filter(tetenr %in% c("I01716040001A", "I01123028002A", 
                       "I01123028003A", "I01123041003A")) |> 
  select(tetenr, teaucd) |> View()
  pivot_longer(cols = -tetenr,
               names_to = "col_nam",
             values_to = "col_value") |> 
  filter(str_detect(col_value, "P"))
  select(where(~ str_detect(., "P"))) |> 
  filter(col_nam == "teaucd")
  
```

### Preços

Informações de preços extraídas pelo Williiam

```{r}
precos <- 
  readxl::read_excel(here::here("data", "Tabela de precos_SPI_SPB_XPERT.xlsx")) |> 
  janitor::clean_names() |> 
  filter(!str_detect(nome_local_de_descarga, "^AMOSTRA"),
         !str_detect(nome_local_de_descarga, "^TESTE"),
         !str_detect(nome_local_de_descarga, "^REM DE TESTE"),
         !str_detect(nome_local_de_descarga, "^PROJETO"),
         !str_detect(nome_local_de_descarga, "^PEDIDO FECHADO PROJETO")
         ) |> 
  filter(preco > 1000) |> 
  rename(item = numero_artigo,
         cod_comp = no_refa_cliente,
         desc = designacao)

precos  |> glimpse()




```

## Já Cadastrados

```{r}
ja_cadastrados <- 
  readxl::read_excel(here::here("data", "2025-10-27-jah_cadastrados.xlsx"),
                     col_types = "text") |> 
  janitor::clean_names() 

cad_precos <- 
  ja_cadastrados |> 
  filter(str_detect(item, "^F")) |> 
  left_join(precos, join_by(item)) |> 
  mutate(tabela_preco = str_sub(familia, start = 3L, end = -1)) |> 
  select(item, tabela_preco, fam_coml, desc, cod_comp, tipo_pedido, necessidade, contrato_standard, 
         cliente, nome_local_de_descarga, numero_do_pedido_de_fecho, preco, valido_de, valido_ate, 
         estabelecimento = planta)

cad_precos |> glimpse()

cad_precos <- 
cad_precos |> 
  select(tabela_preco, item, desc, cod_comp, tipo_pedido, necessidade, contrato_standard, 
         cliente, nome_local_de_descarga, numero_do_pedido_de_fecho, preco, valido_de, valido_ate,
         estabelecimento) |> 
  arrange(tabela_preco, numero_do_pedido_de_fecho, item, cod_comp)


cad_precos |> write_csv2("tabelas-precos.csv")



```

## Finais

Itens acabados ou finais inicial com código F.

Vamos importar apenas aqueles que estiverem ativos (que possuem BOM).

Portugal enviou apenas a lista de itens "Ativos", porém, há itens ativos sem BOM. Estes não serão importados.

Também vamos identificar itens com código do cliente duplicado. Por exemplo, 2 códigos F diferentes com o mesmo código do cliente implica em erro de cadastro. Serão encaminhados para a Engenharia ajustar.

```{r}

# busca lista de peças acabadas que possuem estrutura de produto
f_itens <- get_finished_itens(s_itens)


# F SIMOLDES
f_simoldes <- 
  pedidos_e_vendas |> 
  left_join(f_itens) |> 
  arrange(estabelecimento, cod_comp, item, prj_sigla) |> 
  select(cod_comp, item, estabelecimento, desc, desc2,prj_sigla, prj_desc, ncm)
f_simoldes |> write_rds("data/f-simoldes.rds")

# ESTA LINHA PARA RECUPERAR OS DADOS:
f_simoldes <- read_rds("data/f-simoldes.rds")


# vamos importar no XPert separadamente por estabelecimento.
f_simoldes |> View()



# Vamos reduzir os códigos F apenas para aqueles que aparecem 
# em pedidos_e_vendas
f_itens_excluidos <- 
  pedidos_e_vendas |> 
  anti_join(f_itens)
f_itens_excluidos |> View()

# Códigos para achar itens duplicados:

duplicados_comp <-
  f_simoldes |>
  count(cod_comp, s_ou_mr) |>
  filter(n > 1) |>
  filter(!str_detect(cod_comp, "^-"))

duplicados <-
  duplicados_comp |>
  left_join(f_simoldes) |>
#  pivot_wider(names_from = estabelecimento, values_from = n) |>
  arrange(cod_comp, estabelecimento, prj_sigla, item) |> 
  select(cod_comp, item, estabelecimento, prj_sigla, prj_desc, desc, desc2, un, 
         xp_temagr, xp_tematc)

duplicados |> View()

duplicados |> write_csv("duplicados.csv")
# 
# duplicados |> write_csv("duplicados.csv")
# 
# source("R/read-bom.R")
# bom <- read_bom()
# 
# t_b <- get_bom_from_id("F01612013002A", bom)
# 
# 
# 
# projetos <- 
#   itens |> 
#   filter(str_detect(item, "^F")) 
# 
# projetos |> write_rds("data/projetos.rds")
# projetos <- read_rds("data/projetos.rds")

```

## Preço

```{r}
itens_com_preco <-
  f_itens |>
  left_join(precos |> 
              select(item, cliente, nome_cliente,
                     preco, valido_de, valido_ate, 
                     nome_local_de_descarga, 
                     numero_do_pedido_de_fecho),
            join_by(item)) |> 
  filter(cliente %in% c(991, 992, 1001, 1003, 1004, 1005, 1050, 1051, 1070,
                        1088, 1119, 1120, 1137, 1484, 1817, 1868, 2405, 2437,
                        2815, 2964, 2995, 3139))


itens_com_preco |> nrow()

importar_codigos <- 
  pedidos_e_vendas |> 
  left_join(itens_com_preco, join_by(item == item)) |> 
  mutate(cod_comp = str_trim(cod_comp, side = "both")) |> 
  mutate(cod_comp = str_replace_all(cod_comp, " ", ""))  |> 
  mutate(cod_comp = str_replace_all(cod_comp, "[[:punct:]]", "")) |> 
  filter(!is.na(cod_comp)) |> 
  select(cod_cliente = cod_comp, item, ncm, cliente, 
         nome_cliente, estabelecimento)
  
           

importar_codigos |> write.csv2("importar-codigos.csv")


```

## Importar SPI

```{r}

f_spi <- 
  f_simoldes |>
  filter(estabelecimento == "SPI") |> 
  select(item) |> 
  distinct(item)
f_spi |> nrow()

f_spb <- 
  f_simoldes |> 
  filter(estabelecimento == "SPB") |> 
  select(item) |> 
  distinct(item)
f_spb |> nrow()

f_spi <- 
  f_spi |> 
  left_join(s_itens |> filter(estabelecimento == "SPI")) 



f_spi |> nrow()
f_spi <- 
  f_spi |> 
  filter(!is.na(fam_mat)) |> 
  filter(!is.na(fam_com)) 
f_spi |> nrow()


```

# Importar SPB

```{r}

f_spb <- 
  f_simoldes |>
  filter(estabelecimento == "SPB") |> 
  select(item) |> 
  distinct(item)
f_spb |> nrow()

f_spb <- 
  f_spb |> 
  left_join(s_itens |> filter(estabelecimento == "SPB")) 

f_spb <- 
  f_spb |> 
  left_join(precos |> select(item = numero_artigo, cliente, nome_cliente), join_by(item))

f_spb <- 
  f_spb |>
  mutate(grupo_estoque = "10") |> 
  mutate(fam_mat = case_when(
    str_detect(prj_sigla, "^CXPL") ~   "10CXPLST",
    str_detect(prj_sigla, "^EVI") ~    "10MNEVI",
    str_detect(prj_sigla, "^1312") ~   "10RN1312",
    str_detect(prj_sigla, "^216") ~    "10RN216",
    str_detect(prj_sigla, "^B90") ~    "10RNB90",
    str_detect(prj_sigla, "^H79") ~    "10RNH79",
    str_detect(prj_sigla, "^HHA") ~    "10RNHHA",
    str_detect(prj_sigla, "^HJD") ~    "10RNHJD",
    str_detect(prj_sigla, "^HJF") ~    "10RNHJF",
    str_detect(prj_sigla, "^U79") ~    "10RNU79",
    str_detect(prj_sigla, "^X52") ~    "10RNX52",
    str_detect(prj_sigla, "^H61") ~    "10RNH61",
    str_detect(prj_sigla, "^X62") ~    "10RNX62",
    str_detect(prj_sigla, "^X65") ~    "10RNX65",
    str_detect(prj_sigla, "^X70") ~    "10RNX70",
    str_detect(prj_sigla, "^X84") ~    "10RNX84",
    str_detect(prj_sigla, "^XBB") ~    "10RNXBB",
    str_detect(prj_sigla, "^216") ~    "10VW216",
    str_detect(prj_sigla, "^FOX") ~    "10VWFOX",
    str_detect(prj_sigla, "^GOLF") ~    "10VWGOLF",
    str_detect(prj_sigla, "^V230") ~    "10VWGOLF",
    str_detect(prj_sigla, "^MQB") ~    "10VWMQB",
    str_detect(prj_sigla, "^V216") ~    "10VWV216",
    TRUE ~ NA
  )) |> 
  mutate(fam_com = case_when(
    str_detect(fam_mat, "^10RN") ~ "RN",
    str_detect(fam_mat, "^10VW") ~ "VW",
    str_detect(fam_mat, "^10MN") ~ "MN",
    str_detect(fam_mat, "^10CX") ~ "CX",
    TRUE ~ NA
  )) |> 
  select(item, 
           desc,
           grupo_estoque,
           fam_mat,
           fam_com,
           un,
           estabelecimento,
           cod_comp) |> 
  filter(!is.na(fam_com)) |> 
  filter(!is.na(fam_mat))

f_spb |> nrow()

source("R/import-f.R")
f_to_cd0209(f_spb, "f_spb.lst")

f_spb |>
  select(item) |> 
  left_join(precos, join_by(item == numero_artigo)) |> 
  mutate(no_refa_cliente = str_replace_all(no_refa_cliente, " ", "")) |> 
  filter(!is.na(preco)) |> 
  write_csv2("f_spb.csv")




```

# Intermediários

Importados separadamente os itens F, vamos retomar a lista de f-simoldes para achar e importar os intermediários

```{r}

# O número de peças do conjunto inicial f_simoldes é maior do que 
# nos conjuntos f_spi e f_spb (esta diferença surgiu quando aplicamos filtros 
# na construção das listas por estabelecimento).
f_simoldes |> glimpse()
f_spi |> glimpse()
f_spb |> glimpse()


# Assim, vamos seguir com f_estab
f_estab <- rbind(f_spi, f_spb)

# As peças que não aparecem em f-spi e f-spb ou não possuem código do cliente
# ou são de clientes que não atendemos mais (ex.: Nissan)
f_simoldes |> anti_join(f_estab, join_by(item)) |> View()

f_estab |> write_rds("f-estab.rds")
f_estab <- read_rds("f-estab.rds")

f_estab <- 
  f_estab |> 
  left_join(precos, join_by(item == numero_artigo))

# # PARA RECUPERAR (MAIS PARA BAIXO)
# f_estab |> write_rds("data/f-stab.rds")
# f_estab <- read_rds("data/f-stab.rds")

```

## Ler estruturas de BoM e BoP

```{r}

source("R/read-bom.R")
source("R/read-bop.R")

# file_bom <- here::here("data", "BOM 2025-06-11.xlsx")
# file_bom <- here::here("data", "BOM 2025-09-02.xlsx")
file_bom <- here::here("data", "BOM 2025-11-07.xlsx")
bom <- read_bom(file_bom)

#file_bop_spi <- here::here("data", "BOP SPI 2025-07-20.xlsx")
#file_bop_spb <- here::here("data", "BOP SPB 2025-07-20.xlsx")

file_bop_spi <- here::here("data", "SPI routing 2025-11-12.xlsx")
file_bop_spb <- here::here("data", "SPB routing 2025-11-12.xlsx")

bop_spi <- read_bop(file_bop_spi)
bop_spb <- read_bop(file_bop_spb)

bop_spi |> View()
bop_spb |> View()
bop <- rbind(bop_spi, bop_spb)

bop |> glimpse()

# as operações padrdão deveriam ser apenas
bop |> distinct(description)
  
  
## Alguns itens não possuem BOM registrada!
## Pendente decidir o que fazer com estes!
f_estab |> 
  anti_join(bom, join_by(item == material_number)) |> 
  View()



```

Para cada item vamos identificar a BOM e BOP dele

```{r}

f_estab <- 
  f_estab |> 
  mutate(item_bom = map(item, ~ get_bom_from_id(.x, bom))) |> 
  mutate(item_bop = map(item, ~ get_bop_from_id(.x, bop)))


f_estab <- 
  f_estab |> 
  mutate(num_itens = map(item_bom, ~ nrow(.[1]))) |> 
  mutate(num_itens = unlist(num_itens))

f_estab |> View()

f_estab <- 
  f_estab |> 
  mutate(semiacabado = map(item_bom, ~ get_semi_from_bom(.x))) |> 
  mutate(mp = map(item_bom, ~ get_mp_from_bom(.x)))

# PARA RECUPERAR (MAIS PARA BAIXO)
f_estab |> write_rds("data/f-stab.rds")
f_estab <- read_rds("data/f-stab.rds")


```

Obtém a lista de intermediários e a lista de MP & Comp para cada item:

### semiacabado

```{r}

f_estab |> View()

semi_geral <- 
  f_estab |> 
  select(item, semiacabado)

semi_geral <- 
  semi_geral |> 
  unnest(semiacabado) |> 
  rename(semi = bom_component) |> 
  distinct(item, semi)

ja_cadastrados <- 
  readxl::read_excel(here::here("data", "jah_cadastrados.xlsx")) |> 
  janitor::clean_names() |> 
  select(item, familia, fam_coml)

semi_geral <- 
  semi_geral |> 
  left_join(ja_cadastrados, join_by(item))

semi_geral <- 
  semi_geral |> 
  mutate(familia = str_replace(familia, "10", "20")) |> 
  filter(!is.na(semi), !is.na(familia)) |> 
  select(item = semi, fam_mat = familia, fam_com = fam_coml)

semi_geral |> View()


```

## Importar Semiacabados

```{r}


# vamos eliminar os itens duplicados com famílias diferentes.
semi_geral <- 
  semi_geral  |>
  group_by(item) |> 
  summarise(fam_mat = first(fam_mat),
            fam_com = first(fam_com, na.rm = TRUE)) |> 
  ungroup()

semi_geral  <- 
  semi_geral |> 
  left_join(s_itens, join_by(item)) 

# ANTES DE IMPORTAR VAMOS CRIAR AS FAMÍLIAS DE SEMIACABADOS
# O CÓDIGO ABAIXO GERA LISTA DE FAMÍLIAS DE SEMIACABADOS PARA SEREM REGISTRADAS
semi_geral |> 
  distinct(fam_mat, ncm) |> 
  View()

semi_geral <- 
  semi_geral |> 
  mutate(grupo_de_estoque = "20") |> 
  select(item, desc,
         grupo_estoque = grupo_de_estoque,
         fam_mat, 
         fam_com, 
         un, 
         estabelecimento, 
         cod_comp)


source("R/import-semi.R")
semi_to_cd0209(semi_geral, "semi_geral.lst")


```

## Importar Matéria Prima

```{r}

mp_geral <- 
  f_estab |> 
  select(mp) |> 
  unnest(mp) |> 
  distinct(bom_component) |> 
  rename(item = bom_component) |> 
  left_join(s_itens |> select(item, desc), join_by(item))


# Como obter as famílias de MP e Componentes?
# Vamos utilizar a lista de itens validada pela Engenharia
# Para os itens que não estiverem na lista, vamos complementar manualmente a lista:
mp_fam_sheets <- 
  readxl::excel_sheets(here::here("data", "2025-09-19 classif fam mp.xlsx"))
mp_fam <- 
  readxl::read_excel(here::here("data", "2025-09-19 classif fam mp.xlsx"),
                                sheet = mp_fam_sheets[6]) |> 
  janitor::clean_names() |>
  mutate(fam_mat = as.character(familia_ds)) |> 
  select(item, desc, fam_mat, fam_desc)

# A regra da função abaixo foi utilizada para gerar a primeira versão do arquivo 
# acima... entao... vamos manter por questões históricas, mas não recomendamos usar
#semi_geral <- set_item_family(semi_geral)
# ou ... usamos a classificação da planilha


mp_geral <- 
  mp_geral |> 
  left_join(mp_fam, join_by(item))

mp_geral <- 
mp_geral |> 
  select(item, fam_mat, fam_desc) |> 
  left_join(s_itens, join_by(item))

mp_geral <- 
  mp_geral |> 
  mutate(grupo_de_estoque = "30") |> 
  select(item, 
         desc,
         grupo_estoque = grupo_de_estoque,
         fam_mat, 
         un, 
         estabelecimento, 
         cod_comp)
mp_geral <- 
  mp_geral |> 
  filter(!is.na(item)) |> 
  filter(!is.na(un)) |> 
  mutate(un = ifelse(un == "ROLLS", "UN", un))


source("R/import-mp.R")
mp_to_cd0209(mp_geral, "mp_geral.lst")

```

## BoM do que vai importar

```{r}

i_bom <- bom |> filter(str_detect(material_number, "^I"))
f_bom <- bom |> filter(str_detect(material_number, "^F"))

pseudo <- 
  s_itens |> 
  select(item, pseudo) |> 
  group_by(item) |> 
  summarise_all(first) |> 
  ungroup()

only_this <- 
  s_itens |> 
  distinct(item)

vw246 <- 
  ja_cadastrados |> 
  filter(str_detect(familia, "^VW246"))

bom_vw246 <- 
  vw246 |> 
  select(item) |> 
  left_join(bom, join_by(item == material_number))

source("R/import-bom.R")
goto_en0113(bom_vw246, "bom_vw246.lst")


ren216 <- 
  f_estab |> 
  select(item, fam_mat) |> 
  filter(fam_mat == "^RN216") |> 
  count(item) |> 
  select(item)

bop_246 <- 
  vw246 |> 
  left_join(bop, join_by(item == part_number))

bop_246 <- 
  bop_246 |> 
  group_by(firm, item, description_1, description_2, description) |> 
  summarise_all(first) |> 
  ungroup()

# IMPORTAR PROCESSO


rn <- 
  ja_cadastrados |> 
  filter(str_detect(familia, "^RN"))

rn <- 
rn |>
  select(item) |> 
  left_join(bop, join_by(item == part_number))

rn1 <- 
  rn |> 
  filter(familia %in% c("RNHJF10", "RNHHA10", 
                        "RNU7910", "RNX5210", "RNX6210"))

rn2 <- 
  rn |> 
  filter(familia %in% c("RNX5220", "RN131210",
                        "RN21620", "RNX6510",
                        "RNH6110", "RNH7920"))

rn3 <- 
  rn |> 
  filter(familia %in% c("RNH7910", "RNX6220",
                        "RNXBB10"))

bop_rn1 <- 
  rn1 |> 
  select(item) |> 
  left_join(bop, join_by(item == part_number)) |> 
  group_by(firm, item, description_1, description_2, description) |> 
  summarise_all(first) |> 
  ungroup() |> 
  filter(!is.na(description))

bop_rn2 <- 
  rn2 |> 
  select(item) |> 
  left_join(bop, join_by(item == part_number)) |> 
  group_by(firm, item, description_1, description_2, description) |> 
  summarise_all(first) |> 
  ungroup()|> 
  filter(!is.na(description))

bop_rn3 <- 
  rn3 |> 
  select(item) |> 
  left_join(bop, join_by(item == part_number)) |> 
  group_by(firm, item, description_1, description_2, description) |> 
  summarise_all(first) |> 
  ungroup()|> 
  filter(!is.na(description))

source("R/import-bop.R")
goto_en0114(bop_rn1, "bop_rn1.lst")
goto_en0114(bop_rn2, "bop_rn2.lst")
goto_en0114(bop_rn3, "bop_rn3.lst")

mp <-
  itens |>
  filter(!str_detect(item, "^E1")) |>
  filter(!str_detect(item, "^E2")) |>
  filter(!str_detect(item, "^F0")) |>
  filter(!str_detect(item, "^FA")) |>
  filter(!str_detect(item, "^IO")) |>
  filter(!str_detect(item, "^LM")) |>
  filter(!str_detect(item, "^LP")) |>
  filter(!str_detect(item, "^MA")) |>
  filter(!str_detect(item, "^MO")) |>
  filter(!str_detect(item, "^R1")) |>
  filter(!str_detect(item, "^R2")) |>
  filter(!str_detect(item, "^SE")) |>
  filter(!str_detect(item, "^SP")) |>
  filter(!str_detect(item, "^V1")) |>
  select(item, xp_temagr, xp_mat_group_desc, desc) |>
  filter(!str_detect(item, "^F")) |>    
  filter(!str_detect(item, "^I")) |>    
  filter(!str_detect(item, "^SP"))



```

## 

## Matéria Prima - Para Importar

```{r}


mp <-    
  itens |> 
  filter(item %in% mp_cmp)  

to_imp_itens <-    
  set_item_family(to_imp_itens)   

# Estes dados servem para importar em massa # Antes é preciso criar as famílias 
manualmente to_imp_itens |>    
  select(estabelecimento, item, desc, temagr, mat_group_desc, grupo_estoque, family) |> View()

```

# Importar Estrutura de 1 F

Vamos criar aqui o processo para importar os produtos de 1 item F

```{r}

item_f <- "F02023004001A"

itens |> 
  filter(str_detect(item, item_f)) |> 
  select(estabelecimento = empresa, 
         item = tetenr,
         desc,
         temagr, 
         mat_group_desc,
         grupo_estoque)

# BOM
bom_f <- get_bom_from_id("F02023004001A", bom)
bom_f

manufacted_f <- 
  bom_f |> 
  distinct(material_number) 

manufacted_f <- 
  manufacted_f |> 
  mutate(bop = map(material_number, ~ bop |> filter(part_number == .))) |> 
  unnest(bop) |> 
  mutate(desc = str_c(str_replace_na(description_1, replacement = " "),
                      str_replace_na(description_2, replacement = " ")) |>
           str_trim("both")) |> 
  select(-c(company, variant, description_1, description_2, part_number)) |> 
  select(item = material_number, desc, estabelecimento = firm, part_type,
         cycle_time = cicle_type, piece_time, setup = set_up_time, 
         machine, linha = description, multi_machines, multi_personnel, 
         material_group, matchcode)
  
manufacted_f |> View()

get_itens_from_bom <- function(bom, itens){
  components <-
    bom |> pull(bom_component)

  bom_itens <-
    itens |>
    arrange(estabelecimento, id, familia) |>
    filter(id %in% components) |>
    arrange(id)
}



```

### Acha Fs de item

```{r}

ii <- "1201564"

bom |> 
  filter(str_detect(bom_component, ii)) |> 
  distinct(material_number) |> 
  pull(material_number) |> 
  map(~ bom |> filter(str_detect(bom_component, .)) |> 
        distinct(material_number)) |> 
  reduce(rbind) |> 
  distinct(material_number) |> 
  left_join(projetos, join_by(material_number == item))


projetos |> distinct(prj_sigla, prj_desc) |> View()

```

# Ler Lista de famílias, MP e Componentes gerar aquivo para importar

```{r}

team_file <- here("data", "2025-09-19 classif fam mp.xlsx")

tf_sheets <- readxl::excel_sheets(team_file)

importar <- readxl::read_excel(team_file,
                               sheet = tf_sheets[6]) |> 
  janitor::clean_names() |> 
  select(item, desc, familia_ds, un)

importar <- 
  importar |> 
  group_by(item) |> 
  summarise(desc = first(desc),
            fam_mat = first(familia_ds),
            un = first(un)) |> 
  mutate(grupo_estoque = str_sub(fam_mat, start = 1L, end = 2L),
         fam_com = " ",
         estabelecimento = "102",
         cod_complementar = " ")

importar |> glimpse()

source("R/mass-import-datasul.R")

importar <- 
  importar |> 
  #filter(str_detect(id, "^11")) |> 
  mutate(fam_mat = as.character(fam_mat)) 

build_file_to_cd0209(importar, "mp.txt")


pp |> 
  filter(str_detect(id, "1100002"))



```

## BOM e BOP

### Renault

```{r}
rn <- 
  ja_cadastrados |> 
  filter(str_detect(familia, "^RN"))

bom_rn <- 
  rn |> 
  select(item) |> 
  left_join(bom, join_by(item == material_number))

source("R/import-bom.R")
goto_en0113(bom_rn, "bom_rn.lst")


ren216 <- 
  f_estab |> 
  select(item, fam_mat) |> 
  filter(fam_mat == "^RN216") |> 
  count(item) |> 
  select(item)

bop_246 <- 
  vw246 |> 
  left_join(bop, join_by(item == part_number))

bop_246 <- 
  bop_246 |> 
  group_by(firm, item, description_1, description_2, description) |> 
  summarise_all(first) |> 
  ungroup()

# IMPORTAR PROCESSO


rn <- 
  ja_cadastrados |> 
  filter(str_detect(familia, "^RN"))

rn <- 
rn |>
  select(item) |> 
  left_join(bop, join_by(item == part_number))

rn1 <- 
  rn |> 
  filter(familia %in% c("RNHJF10", "RNHHA10", 
                        "RNU7910", "RNX5210", "RNX6210"))

rn2 <- 
  rn |> 
  filter(familia %in% c("RNX5220", "RN131210",
                        "RN21620", "RNX6510",
                        "RNH6110", "RNH7920"))

rn3 <- 
  rn |> 
  filter(familia %in% c("RNH7910", "RNX6220",
                        "RNXBB10"))

bop_rn1 <- 
  rn1 |> 
  select(item) |> 
  left_join(bop, join_by(item == part_number)) |> 
  group_by(firm, item, description_1, description_2, description) |> 
  summarise_all(first) |> 
  ungroup() |> 
  filter(!is.na(description))

bop_rn2 <- 
  rn2 |> 
  select(item) |> 
  left_join(bop, join_by(item == part_number)) |> 
  group_by(firm, item, description_1, description_2, description) |> 
  summarise_all(first) |> 
  ungroup()|> 
  filter(!is.na(description))

bop_rn3 <- 
  rn3 |> 
  select(item) |> 
  left_join(bop, join_by(item == part_number)) |> 
  group_by(firm, item, description_1, description_2, description) |> 
  summarise_all(first) |> 
  ungroup()|> 
  filter(!is.na(description))

source("R/import-bop.R")
goto_en0114(bop_rn1, "bop_rn1.lst")
goto_en0114(bop_rn2, "bop_rn2.lst")
goto_en0114(bop_rn3, "bop_rn3.lst")
```

### VW

```{r}

vw246 <-
  ja_cadastrados |> 
  filter(str_detect(familia, "^VW246"))
bom_vw246 <- 
  vw246 |> 
  select(item) |> 
  left_join(bom, join_by(item == material_number))

bom_vw246 <- 
  bom_vw246 |> 
  left_join(s_itens |> distinct(item, pseudo), join_by(item))
  
source("R/import-bom.R")
goto_en0113(bom_vw246, "bom_vw246.lst")


bop_vw246 <- 
  vw246 |> 
  select(item) |> 
  left_join(bop, join_by(item == part_number)) |> 
  group_by(firm, item, description_1, description_2, description) |> 
  summarise_all(first) |> 
  ungroup() |> 
  filter(!is.na(description))

source("R/import-bop.R")
goto_en0114(bop_vw246, "bop_vw246.lst")

###

vw <- 
  ja_cadastrados |> 
  filter(str_detect(familia, "^VW"))

bom_vw <- 
  vw |> 
  select(item) |> 
  left_join(bom, join_by(item == material_number))

source("R/import-bom.R")
goto_en0113(bom_vw, "bom_vw.lst")


ren216 <- 
  f_estab |> 
  select(item, fam_mat) |> 
  filter(fam_mat == "^RN216") |> 
  count(item) |> 
  select(item)

bop_246 <- 
  vw246 |> 
  left_join(bop, join_by(item == part_number))

bop_246 <- 
  bop_246 |> 
  group_by(firm, item, description_1, description_2, description) |> 
  summarise_all(first) |> 
  ungroup()

# IMPORTAR PROCESSO


rn <- 
  ja_cadastrados |> 
  filter(str_detect(familia, "^RN"))

rn <- 
rn |>
  select(item) |> 
  left_join(bop, join_by(item == part_number))

rn1 <- 
  rn |> 
  filter(familia %in% c("RNHJF10", "RNHHA10", 
                        "RNU7910", "RNX5210", "RNX6210"))

rn2 <- 
  rn |> 
  filter(familia %in% c("RNX5220", "RN131210",
                        "RN21620", "RNX6510",
                        "RNH6110", "RNH7920"))

rn3 <- 
  rn |> 
  filter(familia %in% c("RNH7910", "RNX6220",
                        "RNXBB10"))

bop_rn1 <- 
  rn1 |> 
  select(item) |> 
  left_join(bop, join_by(item == part_number)) |> 
  group_by(firm, item, description_1, description_2, description) |> 
  summarise_all(first) |> 
  ungroup() |> 
  filter(!is.na(description))

bop_rn2 <- 
  rn2 |> 
  select(item) |> 
  left_join(bop, join_by(item == part_number)) |> 
  group_by(firm, item, description_1, description_2, description) |> 
  summarise_all(first) |> 
  ungroup()|> 
  filter(!is.na(description))

bop_rn3 <- 
  rn3 |> 
  select(item) |> 
  left_join(bop, join_by(item == part_number)) |> 
  group_by(firm, item, description_1, description_2, description) |> 
  summarise_all(first) |> 
  ungroup()|> 
  filter(!is.na(description))

source("R/import-bop.R")
goto_en0114(bop_rn1, "bop_rn1.lst")
goto_en0114(bop_rn2, "bop_rn2.lst")
goto_en0114(bop_rn3, "bop_rn3.lst")
```

### STEL

```{r}
stel <- 
  ja_cadastrados |> 
  filter(str_detect(familia, "^ST"))

bom_st <- 
  stel |> 
  select(item) |> 
  left_join(bom, join_by(item == material_number))

source("R/import-bom.R")
goto_en0113(bom_st, "bom_st.lst")
```

### MANN

```{r}
mn <- 
  ja_cadastrados |> 
  filter(str_detect(familia, "^MN"))

bom_mn <- 
  mn |> 
  select(item) |> 
  left_join(bom, join_by(item == material_number))

source("R/import-bom.R")
goto_en0113(bom_mn, "bom_mn.lst")
```

# Novos Cadastros

```{r}
source("R/import-f.R")

# Novos itens GMB
novos_itens_gmb <- c("F03611011004A", "F03611017001A", "F03611020002A")

novos_itens_gmb <- 
  s_itens |> 
  filter(item %in% novos_itens_gmb)
novos_itens_gmb <- get_f_family_from_xpert_data(novos_itens_gmb)
f_to_cd0209(novos_itens_gmb, "GMB7.lst")


novos_itens_mbb <- c("F01908004001A", "F01908006001A", "F01908006002A",
                     "F01908011001A", "F02108017001B")
novos_itens_mbb <- 
  s_itens |> 
  filter(item %in% novos_itens_mbb)
novos_itens_mbb <- get_f_family_from_xpert_data(novos_itens_mbb)
f_to_cd0209(novos_itens_mbb, "MBB.lst")

```

## Depois...

Depois de listar os códigos F, precisamos importar os itens de BOM.

```{r}
novos_itens_gmb <- 
  novos_itens_gmb |> 
  mutate(bom_item = map(item, ~ get_bom_from_id(.x, bom))) |> 
  mutate(bop_item = map(item, ~ get_bop_from_id(.x, bop)))


bop_spi |>  View()


bom |> filter(material_number  == "I01123046001A")
```

```{r}
import_bom_bop_by_family <- function(family) {

  df <-
    ja_cadastrados |>
    filter(str_detect(familia, str_c("^", family)))
           
  bom <- 
    df |> 
    select(item) |> 
    left_join(bom, join_by(item == material_number))

  bom <- 
    bom |> 
    left_join(s_itens |> distinct(item, pseudo), join_by(item))
  
  goto_en0113(bom, str_c("bom_", family, ".lst"))

  bop <- 
    df |> 
    select(item) |> 
    left_join(bop, join_by(item == part_number)) |> 
    group_by(firm, item, description_1, description_2, description) |> 
    summarise_all(first) |> 
    ungroup() |> 
    filter(!is.na(description))

  goto_en0114(bop, str_c("bop_", family, ".lst"))
}

source("R/import-bom.R")
source("R/import-bop.R")
familias <- 
  ja_cadastrados |> 
  filter(!is.na(fam_coml)) |> 
  distinct(familia) |> 
  filter(!str_detect(familia, "^10")) |>  
  filter(!str_detect(familia, "^20")) |> 
  mutate(familia = str_sub(familia, start = 1L, end = -3)) |> 
  distinct(familia)

fams <- 
  familias |> 
  pull(familia)
walk(fams, import_bom_bop_by_family)


```
